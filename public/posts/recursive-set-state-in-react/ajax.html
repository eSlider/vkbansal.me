<p>I've started working with reactjs and <a href="http://vkbansal.me/blog/using-react-with-backbone">using it with backbone</a>. I was really enjoying working with it, until, I hit a road block with <code>setState</code> method. The <a href="http://facebook.github.io/react/docs/component-api.html#setstate">documentation</a> (at the time of writing v0.12.2) stated the following:</p>
<blockquote>
<p>Merges nextState with the current state. This is the primary method you use to trigger UI updates from event handlers and server request callbacks. In addition, you can supply an optional callback function that is executed once <code>setState</code> is completed and the component is re-rendered.</p>
</blockquote>
<h2>The problem</h2>
<p>The line <code>Merges nextState with the current state</code> lead me in thinking that it will merge the <code>nextState</code> completely or recursively. Lets see that as an example:</p>
<pre><code class="language-jsx">var SomeComponent = React.createClass({
    getInitialState: function(){
        return {
            user: {
                name: &quot;John Doe&quot;,
                email: &quot;johndoe@example.com&quot;
            },
            foo : &quot;bar&quot;
        }
    },
    callJane: function(){
        this.setState({user: {name: &quot;Jane Doe&quot;}});
    },
    render: function(){
        return (
            &lt;div&gt;
                &lt;p&gt;{this.state.user.name}&lt;/p&gt;
                &lt;p&gt;{this.state.user.email}&lt;/p&gt;
                &lt;p&gt;foo is {this.state.foo}&lt;/p&gt;
                &lt;button onClick={this.callJane}&gt;Call Jane&lt;/button&gt;
            &lt;/div&gt;
        );
    }
});

React.render(&lt;SomeComponent /&gt;, document.getElementsByTagName('body')[0]);
</code></pre>
<p>When I click <code>Call Jane</code>, I expected just the name to be updated. But as you can see below, the email also vanished.</p>
<p><img src="/images/2015/react-non-recursive-merge.gif" alt="Non-recursive Merge in ReactJS"></p>
<p>Upon inspection, I found out that the <code>setState</code> merges states only upto single level. So the following <code>InitialState</code></p>
<pre><code class="language-javascript">{
    user: {
        name: &quot;John Doe&quot;,
        email: &quot;johndoe@example.com&quot;
    },
    foo : &quot;bar&quot;
}
</code></pre>
<p>was expected to be</p>
<pre><code class="language-javascript">{
    user: {
        name: &quot;Jane Doe&quot;,
        email: &quot;johndoe@example.com&quot;
    },
    foo : &quot;bar&quot;
}
</code></pre>
<p>But It turned out to be:</p>
<pre><code class="language-javascript">{
    user: {
        name: &quot;Jane Doe&quot;
    },
    foo : &quot;bar&quot;
}
</code></pre>
<h2>The solution</h2>
<p>I looked into utility libraries like underscore, lodash, etc.. Lodash has a <code>merge</code> method and jQuery has <code>$.extend</code> method that merge objects recursively. So I put together a quick mixin for recursive set state.</p>
<pre><code class="language-javascript">//Using jQuery.extend
var setStateRecursiveMixin = {
    setStateRecursive: function(nextState) {
        var prevState = this.state;
        this.setState($.extend(true, {}, prevState, nextState));
    }
};

//Using Lodash.merge
var setStateRecursiveMixin = {
    setStateRecursive: function(nextState) {
        var prevState = this.state;
        this.setState(_.merge(prevState, nextState));
    }
};
</code></pre>
<p>It can be used as follows</p>
<pre><code class="language-jsx">var SomeComponent = React.createClass({
    mixins: [setStateRecursiveMixin],
    getInitialState: function(){
        return {
            user: {
                name: &quot;John Doe&quot;,
                email: &quot;johndoe@example.com&quot;
            },
            foo : &quot;bar&quot;
        }
    },
    callJane: function(){
        this.setStateRecursive({user: {name: &quot;Jane Doe&quot;}});
    },
    render: function(){
        return (
            &lt;div&gt;
                &lt;p&gt;{this.state.user.name}&lt;/p&gt;
                &lt;p&gt;{this.state.user.email}&lt;/p&gt;
                &lt;p&gt;foo is {this.state.foo}&lt;/p&gt;
                &lt;button onClick={this.callJane}&gt;Call Jane&lt;/button&gt;
            &lt;/div&gt;
        );
    }
});

React.render(&lt;SomeComponent /&gt;, document.getElementsByTagName('body')[0]);
</code></pre>
<p>See the mixin in action below:</p>
<p><img src="/images/2015/react-recursive-merge.gif" alt="Recursive Merge in ReactJS"></p>
